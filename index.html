<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Laundry Bin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Custom Styles & Variables */
        :root {
            --primary-color: #3b82f6; /* Tailwind blue-500 */
            --secondary-color: #10b981; /* Tailwind emerald-500 */
            --warning-color: #ef4444; /* Tailwind red-500 */
            --dark-color: #374151; /* Tailwind gray-700 */
            --light-color: #f3f4f6; /* Tailwind gray-100 */
            --transition-speed: 0.3s;
            --progress-dark-bg: #374151; /* gray-700 for dark items */
            --progress-light-bg: #e5e7eb; /* gray-200 for light items */
        }

        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        /* Custom animation for the alert */
        @keyframes blink {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .time-to-wash-blinking {
            animation: blink 1s infinite;
        }

        /* Style for progress bar text */
        .progress-bar-text {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3); /* Add shadow for better readability */
            font-size: 0.75rem; /* text-xs */
        }
        .progress-bar-light-text {
             color: #333; /* Dark text for light background */
             font-weight: bold;
             text-shadow: none; /* No shadow needed */
             font-size: 0.75rem; /* text-xs */
        }

        /* Custom colors for progress bars */
        .progress-bar-dark { background-color: var(--progress-dark-bg); }
        .progress-bar-light { background-color: var(--progress-light-bg); }
        .progress-bar-left { background-color: var(--primary-color); } /* For Dark Bin fullness */
        .progress-bar-right { background-color: var(--secondary-color); } /* For Light Bin fullness */
        .progress-bar-fullness-low { background-color: var(--secondary-color); } /* Green */
        .progress-bar-fullness-medium { background-color: #f59e0b; } /* Amber-500 */
        .progress-bar-fullness-high { background-color: var(--warning-color); } /* Red */

        /* Ensure flex container for split bar doesn't wrap */
        .split-progress-bar {
            display: flex;
            flex-wrap: nowrap;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-blue-500 text-white py-4 shadow-md">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl md:text-3xl font-bold text-center">
                <i class="fas fa-soap mr-2"></i>Smart Laundry Bin Dashboard
            </h1>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-6">
        <div id="timeToWashAlert" class="bg-red-500 text-white p-4 rounded-lg shadow-md text-center mb-6 hidden time-to-wash-blinking">
            <i class="fas fa-exclamation-triangle mr-2"></i> Time to Wash! Your laundry bin is getting full.
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <div class="bg-white rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl">
                        <i class="fas fa-adjust"></i> </div>
                    <h2 class="text-lg font-semibold text-gray-700">Dark vs. Light Ratio</h2>
                </div>

                <div class="mb-3 text-sm text-center">
                    <span class="font-medium text-gray-600">Dark:</span>
                    <span class="font-bold text-gray-800" id="darkRatioText">0%</span> |
                    <span class="font-medium text-gray-600">Light:</span>
                    <span class="font-bold text-gray-800" id="lightRatioText">0%</span>
                </div>

                <div class="w-full bg-gray-300 rounded-full h-5 overflow-hidden split-progress-bar">
                    <div id="darkRatioBar" class="progress-bar-dark h-full flex items-center justify-center transition-all duration-500 ease-out" style="width: 0%">
                         <span class="progress-bar-text"></span> </div>
                    <div id="lightRatioBar" class="progress-bar-light h-full flex items-center justify-center transition-all duration-500 ease-out" style="width: 100%">
                         <span class="progress-bar-light-text"></span> </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-700">Bin Fullness</h2>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="font-medium text-gray-600">Overall Fullness:</span>
                        <span class="font-bold text-gray-800" id="overallFullness">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="fullnessBar" class="h-full rounded-full flex items-center justify-center transition-all duration-500 ease-out progress-bar-fullness-low" style="width: 0%">
                             <span class="progress-bar-text text-sm">0%</span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                     <div class="flex justify-between items-center mb-1 text-sm">
                         <div class="flex items-center">
                             <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--primary-color);"></span>
                             <span class="font-medium text-gray-600">Dark Bin:</span>
                         </div>
                         <span class="font-semibold text-gray-800" id="leftBinOccupancy">0%</span>
                     </div>
                     <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                         <div id="leftBinBar" class="progress-bar-left h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                     </div>
                </div>

                <div>
                     <div class="flex justify-between items-center mb-1 text-sm">
                           <div class="flex items-center">
                               <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--secondary-color);"></span>
                               <span class="font-medium text-gray-600">Light Bin:</span>
                           </div>
                         <span class="font-semibold text-gray-800" id="rightBinOccupancy">0%</span>
                     </div>
                     <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                         <div id="rightBinBar" class="progress-bar-right h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                     </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-700">Laundry Information</h2>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-600">Last Laundry Day:</span>
                        <span class="font-semibold text-gray-800" id="lastLaundryDate">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-600">Days Since Last Wash:</span>
                        <span class="font-semibold text-gray-800" id="daysSinceWash">0</span>
                    </div>
                </div>

                <div class="mt-5 text-center text-xs text-gray-500 bg-gray-100 p-2 rounded-md">
                    Last Updated: <span id="lastUpdate" class="font-medium">-</span>
                </div>
            </div>
        </div>

        <footer class="text-center mt-10 py-5 text-gray-500 text-sm">
            <p>Smart Laundry Bin System Â© 2025 - Automatically updates with real-time data</p>
        </footer>
    </div>

    <script>
        // Firebase configuration - IMPORTANT: replace with your actual Firebase project details
        // Make sure these are correctly filled in for your project.
        const firebaseConfig = {
      apiKey: "AIzaSyDw2Y07IYmFYz2IokzHlvirDhhDOG1cloI",
      authDomain: "rpi-laundry-realtime.firebaseapp.com",
      databaseURL: "https://rpi-laundry-realtime-default-rtdb.firebaseio.com",
      projectId: "rpi-laundry-realtime",
      storageBucket: "rpi-laundry-realtime.firebasestorage.app",
      messagingSenderId: "671997705566",
      appId: "1:671997705566:web:1dcfacfbfab2b0a86f23cf"
    };

        // Initialize Firebase
        try {
            if (!firebase.apps.length) { // Prevent re-initialization
                 firebase.initializeApp(firebaseConfig);
            }
        } catch (e) {
            console.error("Firebase initialization error:", e);
            // Avoid using alert in production, consider a less intrusive notification
            // alert("Error initializing Firebase. Please check your configuration.");
            document.body.insertAdjacentHTML('afterbegin', '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4" role="alert"><strong class="font-bold">Firebase Error!</strong><span class="block sm:inline"> Could not initialize Firebase. Check console and configuration.</span></div>');
        }

        // Reference to the database
        const database = firebase.database();

        // --- DOM Element References ---
        // Ratio Card Elements
        const darkRatioTextEl = document.getElementById('darkRatioText');
        const lightRatioTextEl = document.getElementById('lightRatioText');
        const darkRatioBarEl = document.getElementById('darkRatioBar');
        const lightRatioBarEl = document.getElementById('lightRatioBar');
        const darkRatioBarTextSpan = darkRatioBarEl.querySelector('span'); // Optional text inside bar
        const lightRatioBarTextSpan = lightRatioBarEl.querySelector('span'); // Optional text inside bar

        // Fullness Card Elements
        const overallFullnessEl = document.getElementById('overallFullness');
        const fullnessBarEl = document.getElementById('fullnessBar');
        const fullnessBarTextEl = fullnessBarEl.querySelector('span'); // Get span inside fullness bar
        const leftBinOccupancyEl = document.getElementById('leftBinOccupancy');
        const rightBinOccupancyEl = document.getElementById('rightBinOccupancy');
        const leftBinBarEl = document.getElementById('leftBinBar');
        const rightBinBarEl = document.getElementById('rightBinBar');

        // Info Card Elements
        const lastLaundryDateEl = document.getElementById('lastLaundryDate');
        const daysSinceWashEl = document.getElementById('daysSinceWash');
        const lastUpdateEl = document.getElementById('lastUpdate');

        // Alert Element
        const timeToWashAlertEl = document.getElementById('timeToWashAlert');


        // --- Firebase Data Listener ---
        database.ref('/').on('value', (snapshot) => {
            const data = snapshot.val();
            console.log("Received data:", data); // Log received data for debugging

            if (data) {
                // --- Get Occupancy Data ---
                // Assume left bin is for darks, right bin is for lights
                const leftOccupancy = data.leftBinOccupancy || 0; // Percentage (0-100)
                const rightOccupancy = data.rightBinOccupancy || 0; // Percentage (0-100)
                const overallFullness = data.overallFullness || 0; // Use overallFullness directly

                // --- Update Bin Fullness Card ---
                updateProgressBar(leftBinOccupancyEl, leftBinBarEl, leftOccupancy);
                updateProgressBar(rightBinOccupancyEl, rightBinBarEl, rightOccupancy);
                updateProgressBar(overallFullnessEl, fullnessBarEl, overallFullness, fullnessBarTextEl);

                // Update Fullness Bar Color based on overall fullness
                updateFullnessBarColor(fullnessBarEl, overallFullness);

                // --- Calculate and Update Dark vs Light Ratio Card ---
                // We need a way to determine the *amount* in each bin, not just percentage full.
                // For this example, we'll *assume* the occupancy percentage directly relates
                // to the proportion of dark/light clothes *if both bins were combined*.
                // This is an approximation. A better system might track item counts.
                const totalCombinedOccupancy = leftOccupancy + rightOccupancy; // This might exceed 100 if bins are full
                let darkRatio = 0;
                let lightRatio = 0;

                if (totalCombinedOccupancy > 0) {
                    // Calculate ratio based on the *relative* occupancy of each bin
                    darkRatio = (leftOccupancy / totalCombinedOccupancy) * 100;
                }
                 // Ensure ratios are valid percentages
                darkRatio = Math.max(0, Math.min(Math.round(darkRatio), 100));
                lightRatio = 100 - darkRatio;

                updateRatioDisplay(darkRatio, lightRatio);


                // --- Update Date Information ---
                if (data.lastLaundryDate) {
                    lastLaundryDateEl.textContent = formatDate(data.lastLaundryDate);
                    daysSinceWashEl.textContent = calculateDaysDifference(data.lastLaundryDate);
                } else {
                    lastLaundryDateEl.textContent = '-';
                    daysSinceWashEl.textContent = '0';
                }

                // --- Update Last Update Time ---
                updateLastUpdateTime(data.lastUpdate);

                // --- Show/Hide "Time to Wash" Alert ---
                // Trigger alert if overall fullness is high (e.g., > 80%)
                const showWashAlert = overallFullness > 80; // Threshold
                timeToWashAlertEl.style.display = showWashAlert ? 'block' : 'none';

            } else {
                 console.warn("No data received from Firebase.");
                 // Reset the dashboard to default values if no data is found
                 resetDashboard();
            }
        }, (error) => {
             console.error("Firebase read failed:", error);
             // Show an error message to the user
             document.body.insertAdjacentHTML('afterbegin', `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4" role="alert"><strong class="font-bold">Firebase Error!</strong><span class="block sm:inline"> Could not read data. Check console.</span></div>`);
             // Reset or show an error state on the dashboard
             resetDashboard();
        });

        // --- Helper Functions ---

        /**
         * Updates a text element and its corresponding progress bar.
         * @param {HTMLElement} textElement - The element displaying the percentage text (optional).
         * @param {HTMLElement} barElement - The progress bar element.
         * @param {number} value - The percentage value (0-100).
         * @param {HTMLElement|null} barTextElement - The specific span element inside the bar for text (optional).
         */
        function updateProgressBar(textElement, barElement, value, barTextElement = null) {
            const roundedValue = Math.round(value);
            const clampedValue = Math.max(0, Math.min(roundedValue, 100)); // Ensure value is 0-100
            const formattedValue = `${clampedValue}%`;

            if (textElement) {
                textElement.textContent = formattedValue;
            }

            if (barElement) {
                barElement.style.width = formattedValue;
                if (barTextElement) { // If a specific element for text inside the bar is provided
                     barTextElement.textContent = formattedValue;
                }
            }
        }

        /**
         * Updates the color classes of the overall fullness progress bar based on the value.
         * @param {HTMLElement} barElement - The fullness progress bar element.
         * @param {number} value - The percentage value (0-100).
         */
        function updateFullnessBarColor(barElement, value) {
            // Remove existing color classes
            barElement.classList.remove('progress-bar-fullness-low', 'progress-bar-fullness-medium', 'progress-bar-fullness-high');

            // Add the appropriate color class
            if (value > 80) {
                barElement.classList.add('progress-bar-fullness-high');
            } else if (value > 50) {
                 barElement.classList.add('progress-bar-fullness-medium');
            } else {
                 barElement.classList.add('progress-bar-fullness-low');
            }
        }

        /**
         * Updates the dark/light ratio text and split progress bar.
         * @param {number} darkPercent - Percentage of dark items (0-100).
         * @param {number} lightPercent - Percentage of light items (0-100).
         */
        function updateRatioDisplay(darkPercent, lightPercent) {
            // Update text elements
            darkRatioTextEl.textContent = `${darkPercent}%`;
            lightRatioTextEl.textContent = `${lightPercent}%`;

            // Update the width of the split bar segments
            darkRatioBarEl.style.width = `${darkPercent}%`;
            lightRatioBarEl.style.width = `${lightPercent}%`;

            // Optional: Update text inside the bars if needed (can be distracting)
            // darkRatioBarTextSpan.textContent = darkPercent > 10 ? `${darkPercent}%` : ''; // Only show if space allows
            // lightRatioBarTextSpan.textContent = lightPercent > 10 ? `${lightPercent}%` : '';
        }


        /**
         * Formats a date string (assuming YYYY-MM-DD or parsable format) to MM/DD/YYYY.
         * @param {string} dateStr - The input date string.
         * @returns {string} - Formatted date string or the original string if formatting fails.
         */
        function formatDate(dateStr) {
            try {
                // Attempt to create a date object, add T00:00:00 to avoid timezone interpretation issues
                const date = new Date(dateStr + 'T00:00:00');
                if (isNaN(date.getTime())) { // Check if the created date is valid
                    throw new Error("Invalid date string provided");
                }
                // Use Intl.DateTimeFormat for locale-aware formatting (recommended)
                // return new Intl.DateTimeFormat('en-US').format(date); // Example: US format

                // Manual formatting (fallback)
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();
                return `${month}/${day}/${year}`;
            } catch (e) {
                console.warn("Could not format date:", dateStr, e);
                return dateStr; // Return original string on error
            }
        }

        /**
         * Calculates the difference in days between a given date string and today.
         * @param {string} dateStr - The input date string (YYYY-MM-DD or parsable).
         * @returns {number} - The number of days difference.
         */
        function calculateDaysDifference(dateStr) {
             try {
                 const laundryDate = new Date(dateStr + 'T00:00:00'); // Ensure consistent time part
                 if (isNaN(laundryDate.getTime())) {
                     throw new Error("Invalid date string for difference calculation");
                 }
                 const today = new Date();

                 // Reset time part of both dates to compare days accurately
                 laundryDate.setHours(0, 0, 0, 0);
                 today.setHours(0, 0, 0, 0);

                 // Calculate difference in milliseconds and convert to days
                 const diffTime = today - laundryDate; // Difference in milliseconds
                 const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Convert ms to days

                 return Math.max(0, diffDays); // Ensure result is not negative
              } catch(e) {
                  console.warn("Could not calculate date difference for:", dateStr, e);
                  return 0; // Return 0 on error
              }
        }

         /**
         * Updates the 'Last Updated' timestamp display.
         * @param {string | number | undefined} timestamp - The timestamp from Firebase (can be various formats).
         */
        function updateLastUpdateTime(timestamp) {
            let updateText = '-';
            if (timestamp) {
                try {
                    // Attempt to create a Date object from the timestamp
                    const updateDate = new Date(timestamp);
                    // Check if the date is valid
                    if (!isNaN(updateDate.getTime())) {
                         // Format the date and time for display
                         updateText = updateDate.toLocaleString(); // Uses browser's locale settings
                    } else {
                        // If timestamp is not directly parsable as a date, display it as is
                        updateText = String(timestamp);
                        console.warn("Last update timestamp was not a standard parsable format:", timestamp);
                    }
                } catch (e) {
                     // Fallback to raw string if Date object creation fails
                     updateText = String(timestamp);
                     console.error("Error processing last update timestamp:", timestamp, e);
                }
            } else {
                 // If no timestamp provided, use the current time as a fallback
                 updateText = new Date().toLocaleString();
            }
             lastUpdateEl.textContent = updateText;
        }


        /**
         * Resets all dashboard elements to their default/initial state.
         */
         function resetDashboard() {
             console.log("Resetting dashboard...");
             // Reset Ratio Card
             updateRatioDisplay(0, 0); // Sets text and bar widths

             // Reset Fullness Card
             updateProgressBar(overallFullnessEl, fullnessBarEl, 0, fullnessBarTextEl);
             updateProgressBar(leftBinOccupancyEl, leftBinBarEl, 0);
             updateProgressBar(rightBinOccupancyEl, rightBinBarEl, 0);
             updateFullnessBarColor(fullnessBarEl, 0); // Reset color

             // Reset Info Card
             lastLaundryDateEl.textContent = '-';
             daysSinceWashEl.textContent = '0';
             lastUpdateEl.textContent = '-';

             // Hide Alert
             timeToWashAlertEl.style.display = 'none';
         }

         // Optional: Call resetDashboard on initial load to show default values
         // while waiting for the first Firebase update.
         // resetDashboard();

    </script>
</body>
</html>
