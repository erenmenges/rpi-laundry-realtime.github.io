<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Laundry Bin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic Custom Styles (Tailwind will handle most) */
        :root {
            --primary-color: #3b82f6; /* Tailwind blue-500 */
            --secondary-color: #10b981; /* Tailwind emerald-500 */
            --warning-color: #ef4444; /* Tailwind red-500 */
            --dark-color: #374151; /* Tailwind gray-700 */
            --light-color: #f3f4f6; /* Tailwind gray-100 */
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
        }

        /* Custom animation for the alert */
        @keyframes blink {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .time-to-wash-blinking {
            animation: blink 1s infinite;
        }

        /* Style for progress bar text */
        .progress-bar-text {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3); /* Add shadow for better readability */
        }
        .progress-bar-light-text {
             color: #333; /* Dark text for light background */
             font-weight: bold;
             text-shadow: none; /* No shadow needed */
        }

        /* Custom colors for progress bars (can be overridden by JS) */
        .progress-bar-dark { background-color: #333; }
        .progress-bar-light { background-color: #eaeaea; }
        .progress-bar-left { background-color: var(--primary-color); }
        .progress-bar-right { background-color: var(--secondary-color); }
        .progress-bar-fullness-low { background-color: var(--secondary-color); } /* Green */
        .progress-bar-fullness-medium { background-color: #f59e0b; } /* Amber-500 */
        .progress-bar-fullness-high { background-color: var(--warning-color); } /* Red */


    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-blue-500 text-white py-4 shadow-md">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl md:text-3xl font-bold text-center">
                <i class="fas fa-soap mr-2"></i>Smart Laundry Bin Dashboard
            </h1>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-6">
        <div id="timeToWashAlert" class="bg-red-500 text-white p-4 rounded-lg shadow-md text-center mb-6 hidden time-to-wash-blinking">
            <i class="fas fa-exclamation-triangle mr-2"></i> Time to Wash! Your laundry bin is getting full.
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <div class="bg-white rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl">
                        <i class="fas fa-tshirt"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-700">Clothing Distribution</h2>
                </div>

                <div class="mb-3">
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="font-medium text-gray-600">Dark Items:</span>
                        <span class="font-bold text-gray-800" id="coloredPercentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
                        <div id="coloredBar" class="progress-bar-dark h-full rounded-full flex items-center justify-center transition-all duration-500 ease-out" style="width: 0%">
                            <span class="progress-bar-text text-xs">0%</span>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="font-medium text-gray-600">Light Items:</span>
                        <span class="font-bold text-gray-800" id="whitePercentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
                        <div id="whiteBar" class="progress-bar-light h-full rounded-full flex items-center justify-center transition-all duration-500 ease-out" style="width: 0%">
                             <span class="progress-bar-light-text text-xs">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-700">Bin Fullness</h2>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="font-medium text-gray-600">Overall Fullness:</span>
                        <span class="font-bold text-gray-800" id="overallFullness">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="fullnessBar" class="h-full rounded-full flex items-center justify-center transition-all duration-500 ease-out progress-bar-fullness-low" style="width: 0%">
                             <span class="progress-bar-text text-sm">0%</span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                     <div class="flex justify-between items-center mb-1 text-sm">
                        <div class="flex items-center">
                             <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--primary-color);"></span>
                             <span class="font-medium text-gray-600">Dark Bin:</span>
                        </div>
                        <span class="font-semibold text-gray-800" id="leftBinOccupancy">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="leftBinBar" class="progress-bar-left h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                </div>

                <div>
                     <div class="flex justify-between items-center mb-1 text-sm">
                         <div class="flex items-center">
                             <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--secondary-color);"></span>
                             <span class="font-medium text-gray-600">Light Bin:</span>
                         </div>
                        <span class="font-semibold text-gray-800" id="rightBinOccupancy">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="rightBinBar" class="progress-bar-right h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-5 hover:shadow-xl transition-shadow duration-300">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-700">Laundry Information</h2>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-600">Last Laundry Day:</span>
                        <span class="font-semibold text-gray-800" id="lastLaundryDate">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-600">Days Since Last Wash:</span>
                        <span class="font-semibold text-gray-800" id="daysSinceWash">0</span>
                    </div>
                </div>

                <div class="mt-5 text-center text-xs text-gray-500 bg-gray-100 p-2 rounded-md">
                    Last Updated: <span id="lastUpdate" class="font-medium">-</span>
                </div>
            </div>
        </div>

        <footer class="text-center mt-10 py-5 text-gray-500 text-sm">
            <p>Smart Laundry Bin System Â© 2025 - Automatically updates with real-time data</p>
        </footer>
    </div>

    <script>
        // Firebase configuration - IMPORTANT: replace with your actual Firebase project details
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace
            authDomain: "YOUR_AUTH_DOMAIN", // Replace
            databaseURL: "YOUR_DATABASE_URL", // Replace
            projectId: "YOUR_PROJECT_ID", // Replace
            storageBucket: "YOUR_STORAGE_BUCKET", // Replace
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // Replace
            appId: "YOUR_APP_ID" // Replace
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            alert("Error initializing Firebase. Please check your configuration.");
        }

        // Reference to the database
        const database = firebase.database();

        // --- DOM Element References ---
        const coloredPercentageEl = document.getElementById('coloredPercentage');
        const whitePercentageEl = document.getElementById('whitePercentage');
        const coloredBarEl = document.getElementById('coloredBar');
        const whiteBarEl = document.getElementById('whiteBar');
        const overallFullnessEl = document.getElementById('overallFullness');
        const fullnessBarEl = document.getElementById('fullnessBar');
        const leftBinOccupancyEl = document.getElementById('leftBinOccupancy');
        const rightBinOccupancyEl = document.getElementById('rightBinOccupancy');
        const leftBinBarEl = document.getElementById('leftBinBar');
        const rightBinBarEl = document.getElementById('rightBinBar');
        const lastLaundryDateEl = document.getElementById('lastLaundryDate');
        const daysSinceWashEl = document.getElementById('daysSinceWash');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const timeToWashAlertEl = document.getElementById('timeToWashAlert');
        const coloredBarTextEl = coloredBarEl.querySelector('span'); // Get span inside colored bar
        const whiteBarTextEl = whiteBarEl.querySelector('span'); // Get span inside white bar
        const fullnessBarTextEl = fullnessBarEl.querySelector('span'); // Get span inside fullness bar


        // --- Firebase Data Listener ---
        database.ref('/').on('value', (snapshot) => {
            const data = snapshot.val();
            console.log("Received data:", data); // Log received data for debugging

            if (data) {
                // --- Update Bin Fullness ---
                const leftOccupancy = data.leftBinOccupancy || 0;
                const rightOccupancy = data.rightBinOccupancy || 0;
                const overallFullness = data.overallFullness || 0; // Use overallFullness directly if available, otherwise calculate

                updateElement(leftBinOccupancyEl, leftBinBarEl, leftOccupancy, false); // No text in these bars
                updateElement(rightBinOccupancyEl, rightBinBarEl, rightOccupancy, false); // No text in these bars
                updateElement(overallFullnessEl, fullnessBarEl, overallFullness, true, fullnessBarTextEl); // Text needed here

                // --- Calculate Clothing Distribution Ratio ---
                const totalOccupancy = leftOccupancy + rightOccupancy;
                let darkRatio = 0;
                let lightRatio = 0;

                if (totalOccupancy > 0) {
                    darkRatio = (leftOccupancy / totalOccupancy) * 100;
                    lightRatio = (rightOccupancy / totalOccupancy) * 100;
                }
                 // Ensure ratios don't exceed 100 due to potential floating point issues
                darkRatio = Math.min(darkRatio, 100);
                lightRatio = Math.min(lightRatio, 100);


                // --- Update Clothing Distribution UI ---
                updateElement(coloredPercentageEl, coloredBarEl, darkRatio, true, coloredBarTextEl);
                updateElement(whitePercentageEl, whiteBarEl, lightRatio, true, whiteBarTextEl);


                // --- Update Fullness Bar Color ---
                if (overallFullness > 80) {
                    fullnessBarEl.className = fullnessBarEl.className.replace(/progress-bar-fullness-\w+/g, 'progress-bar-fullness-high');
                } else if (overallFullness > 50) {
                     fullnessBarEl.className = fullnessBarEl.className.replace(/progress-bar-fullness-\w+/g, 'progress-bar-fullness-medium');
                } else {
                     fullnessBarEl.className = fullnessBarEl.className.replace(/progress-bar-fullness-\w+/g, 'progress-bar-fullness-low');
                }

                // --- Update Date Information ---
                if (data.lastLaundryDate) {
                    lastLaundryDateEl.textContent = formatDate(data.lastLaundryDate);
                    daysSinceWashEl.textContent = calculateDaysDifference(data.lastLaundryDate);
                } else {
                    lastLaundryDateEl.textContent = '-';
                    daysSinceWashEl.textContent = '0';
                }

                // --- Update Last Update Time ---
                if (data.lastUpdate) {
                    // Format timestamp for better readability
                    try {
                       const updateDate = new Date(data.lastUpdate);
                       lastUpdateEl.textContent = updateDate.toLocaleString();
                    } catch (e) {
                       lastUpdateEl.textContent = data.lastUpdate; // Fallback to raw string
                       console.warn("Could not parse lastUpdate timestamp:", data.lastUpdate);
                    }
                } else {
                    lastUpdateEl.textContent = new Date().toLocaleString(); // Use current time if not provided
                }

                // --- Show/Hide "Time to Wash" Alert ---
                // Trigger alert if overall fullness is high (e.g., > 80%)
                const showWashAlert = overallFullness > 80; // Example threshold
                timeToWashAlertEl.style.display = showWashAlert ? 'block' : 'none';

            } else {
                 console.warn("No data received from Firebase.");
                 // Optionally reset the dashboard if no data is found
                 resetDashboard();
            }
        }, (error) => {
             console.error("Firebase read failed:", error);
             alert("Error reading data from Firebase. Check console for details.");
             // Optionally reset or show an error state on the dashboard
             resetDashboard();
        });

        // --- Helper Functions ---

        /**
         * Updates a text element and optionally a progress bar.
         * @param {HTMLElement} textElement - The element displaying the percentage text.
         * @param {HTMLElement} barElement - The progress bar element.
         * @param {number} value - The percentage value (0-100).
         * @param {boolean} showTextInBar - Whether to show the percentage text inside the bar.
         * @param {HTMLElement} barTextElement - The specific span element inside the bar for text.
         */
        function updateElement(textElement, barElement, value, showTextInBar = false, barTextElement = null) {
            const roundedValue = Math.round(value);
            const formattedValue = `${roundedValue}%`;

            if (textElement) {
                textElement.textContent = formattedValue;
            }

            if (barElement) {
                barElement.style.width = formattedValue;
                if (showTextInBar && barTextElement) {
                     barTextElement.textContent = formattedValue;
                } else if (showTextInBar && !barTextElement) {
                    // Fallback if the specific text element wasn't passed but text is requested
                    // This might happen if the bar structure changes
                    barElement.textContent = formattedValue;
                } else if (!showTextInBar && barTextElement) {
                    // Ensure text is cleared if not needed
                    barTextElement.textContent = '';
                }
            }
        }

        /**
         * Formats a date string (assuming YYYY-MM-DD or parsable format) to MM/DD/YYYY.
         * @param {string} dateStr - The input date string.
         * @returns {string} - Formatted date string or the original string if formatting fails.
         */
        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr + 'T00:00:00'); // Add time part to avoid timezone issues
                if (isNaN(date.getTime())) { // Check if date is valid
                    throw new Error("Invalid date string");
                }
                // Use Intl for better locale support, but fallback for simplicity here
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = date.getFullYear();
                return `${month}/${day}/${year}`;
            } catch (e) {
                console.warn("Could not format date:", dateStr, e);
                return dateStr; // Return original string on error
            }
        }

        /**
         * Calculates the difference in days between a given date string and today.
         * @param {string} dateStr - The input date string (YYYY-MM-DD or parsable).
         * @returns {number} - The number of days difference.
         */
        function calculateDaysDifference(dateStr) {
             try {
                const laundryDate = new Date(dateStr + 'T00:00:00'); // Ensure consistent time part
                if (isNaN(laundryDate.getTime())) {
                     throw new Error("Invalid date string");
                }
                const today = new Date();

                // Reset time part for accurate day calculation
                laundryDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);

                // Calculate difference in milliseconds and convert to days
                const diffTime = today - laundryDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                return Math.max(0, diffDays); // Ensure it's not negative
             } catch(e) {
                 console.warn("Could not calculate date difference for:", dateStr, e);
                 return 0; // Return 0 on error
             }
        }

        /**
         * Resets all dashboard elements to their default state.
         */
         function resetDashboard() {
            console.log("Resetting dashboard...");
            updateElement(coloredPercentageEl, coloredBarEl, 0, true, coloredBarTextEl);
            updateElement(whitePercentageEl, whiteBarEl, 0, true, whiteBarTextEl);
            updateElement(overallFullnessEl, fullnessBarEl, 0, true, fullnessBarTextEl);
            updateElement(leftBinOccupancyEl, leftBinBarEl, 0, false);
            updateElement(rightBinOccupancyEl, rightBinBarEl, 0, false);
            lastLaundryDateEl.textContent = '-';
            daysSinceWashEl.textContent = '0';
            lastUpdateEl.textContent = '-';
            timeToWashAlertEl.style.display = 'none';
            // Reset fullness bar color
            fullnessBarEl.className = fullnessBarEl.className.replace(/progress-bar-fullness-\w+/g, 'progress-bar-fullness-low');
         }

         // Initial call to potentially set defaults if Firebase connection is delayed
         // resetDashboard(); // You might uncomment this if you want defaults shown immediately

    </script>
</body>
</html>
